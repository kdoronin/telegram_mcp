# Telegram MCP Server

[English version](README.md) | Русская версия

Сервер для работы с Telegram API через Model Context Protocol (MCP). Позволяет AI-агентам и другим MCP-клиентам взаимодействовать с Telegram.

## Требования

- Node.js 14+ (или выше)
- npm
- API ID и API Hash от Telegram

## Установка

1. Клонируйте репозиторий:
   ```bash
   git clone <repository-url>
   cd telegram-mcp
   ```

2. Установите зависимости:
   ```bash
   npm install
   ```
   *(Это установит необходимые пакеты: `gramjs`, `@modelcontextprotocol/sdk`, `zod` и др.)*

3. Создайте и настройте файл `.env`:
   ```bash
   # Скопируйте пример файла .env
   cp .env.example .env
   ```
   Отредактируйте файл `.env` и укажите свои `API_ID` и `API_HASH`.

4. Получите API ID и API Hash:
   - Перейдите на сайт [my.telegram.org](https://my.telegram.org)
   - Войдите в свой аккаунт
   - Перейдите в "API development tools"
   - Создайте новое приложение
   - Скопируйте `api_id` и `api_hash` в файл `.env`

## Запуск

### Важное замечание о запуске

Основной файл сервера `mcp-server.js` находится в корне проекта, что позволяет запускать его без проблем с путями.

### Вариант 1: Через npm (рекомендуется)

```bash
npm run mcp    # Запуск из корневой директории проекта
```

### Вариант 2: Прямой запуск node

```bash
# Запуск из корневой директории проекта
node mcp-server.js
```

### Вариант 3: Как исполняемый файл

```bash
# Из корня проекта
./mcp-server.js
```

### Вариант 4: После глобальной установки

```bash
npm install -g .   # Установка пакета глобально
telegram-mcp       # Запуск глобально установленного пакета
```

## Интеграция с MCP-клиентами

### Настройка в Cursor

1. Откройте настройки Cursor
2. Перейдите в раздел Features -> MCP Servers
3. Нажмите "Add new MCP server"
4. Настройте сервер:
   - **Имя**: `telegram` (или любое другое)
   - **Тип**: `command`
   - **Команда**: `node /полный/путь/к/проекту/mcp-server.js`
   - Альтернативно: `npx telegram-mcp` (после глобальной установки)

### Настройка в Claude Desktop

1. Откройте настройки Claude Desktop
2. Перейдите в раздел Tools -> MCP
3. Нажмите "Add New Server"
4. Настройте сервер:
   - **Имя**: `telegram` (или любое другое)
   - **Тип**: `command`
   - **Команда**: `node /полный/путь/к/проекту/mcp-server.js`
   - Альтернативно: `npx telegram-mcp` (после глобальной установки)

## Проверка работоспособности

При запуске сервер:
1. Загрузит настройки из файла `.env`
2. Проверит наличие сохраненных сессий
3. Если сессий нет, предложит создать новую (потребуется ввести номер телефона и код подтверждения)

## Доступные инструменты (Tools)

MCP-сервер предоставляет следующие инструменты:

- **`getDialogs`**: Получает список диалогов (чатов) пользователя.
  - Параметры: `session` (string, required), `limit` (integer, optional, default: 100).
- **`getMessages`**: Получает сообщения из указанного чата.
  - Параметры: `session` (string, required), `chatId` (string, required), `limit` (integer, optional, default: 100).
- **`sendMessage`**: Отправляет сообщение в указанный чат.
  - Параметры: `session` (string, required), `chatId` (string, required), `message` (string, required).
- **`executeMethod`**: Выполняет произвольный метод Telegram API (используйте с осторожностью).
  - Параметры: `session` (string, required), `method` (string, required), `params` (object, optional).

*Примечание: Параметр `session` обычно является номером телефона пользователя в международном формате (например, `+79001234567`).*

## Примеры использования в промптах

```
Используя инструмент telegram.getDialogs для сессии +79001234567, покажи мне последние 5 чатов.
```

```
С помощью telegram.sendMessage для сессии +79001234567, отправь сообщение "Привет от моего AI ассистента!" в чат с ID 'username_or_chat_id'.
```

## Авторизация

При первом использовании `session` (номера телефона) сервер запросит **код подтверждения в консоли**, где он запущен. Введите код, полученный от Telegram, чтобы авторизовать сессию. 

Если у вас установлена двухфакторная аутентификация (2FA), вам также потребуется ввести ваш пароль от Telegram. При неверном вводе пароля система предложит ввести его повторно (до 3 попыток).

После успешной авторизации сессия будет сохранена в файл внутри директории `sessions/` и будет использоваться для последующих запросов.

## Структура файлов сессий

Сессии хранятся в директории `sessions/` в формате JSON-файлов, названных по номеру телефона (например, `+79001234567.json`). Каждый файл содержит:
- Строку сессии (зашифрованный токен авторизации)
- Временную метку создания/обновления

## Устранение неполадок

1. **Ошибка "Your API ID or Hash cannot be empty or undefined"**
   - Проверьте, что файл `.env` находится в корне проекта
   - Убедитесь, что в нём правильно указаны API_ID и API_HASH
   - Запустите сервер из корневой директории проекта

2. **Сервер не видит сохраненную сессию**
   - Проверьте путь запуска (должен быть из корня проекта)
   - Проверьте наличие файла сессии в директории `sessions/`
   - Попробуйте запустить через `npm run mcp`

3. **Ошибка авторизации**
   - Если вы ввели неверный пароль 2FA, система предложит повторить ввод
   - Если все попытки исчерпаны, удалите файл сессии и попробуйте заново

## Безопасность

- **Не передавайте API ID и API Hash третьим лицам.**
- **Запускайте сервер в доверенной среде.**
- **Файлы сессий содержат чувствительные данные.** Храните их в безопасном месте и не делитесь ими.
- Инструмент `executeMethod` позволяет выполнять любые методы Telegram API. Используйте его с осторожностью, так как он может выполнять деструктивные действия.

## Лицензия

MIT 